# 规范说明书 (Spec): BVM 智能升级与健康体系

## 1. 概述 (Overview)
重构 BVM 的核心升级逻辑，实现基于组件内容的增量更新、原子替换以及环境自愈功能。避免盲目覆盖所有文件，降低升级失败风险，并提升用户对新版本的感知。

## 2. 功能需求 (Functional Requirements)

### A. 智能增量升级
- **多组件管理**：将 `index.js`, `bvm-shim.js`, `bvm-shim.sh` 定义为待分发组件。
- **指纹比对**：通过 `HEAD` 请求获取远程文件的 `ETag` 或 `Content-Length`，与本地进行对比。
- **原子替换**：下载至 `.tmp` -> 校验 -> 备份旧版 -> 移动至目标位置。

### B. 自愈机制
- **本地模板刷新**：升级完成后运行 `bvm setup --silent` 以更新包装器脚本（`.cmd` / shell），确保包装器逻辑与核心对齐。
- **多源下载**：复用 Race Strategy 在 jsDelivr 和 GitHub 镜像之间选择最快下载点。

### C. 版本感知
- **更新检查器**：在运行特定命令时异步检测新版本。
- **UI 提示**：优雅提示用户有新版本可用。

## 3. 验收标准 (Acceptance Criteria)
- `bvm upgrade` 仅下载发生变化的文件。
- 升级过程稳健，支持在失败时回滚。
- 包装器脚本在升级后自动刷新为最新版本。
- 所有逻辑支持 Windows 和 Unix 平台。
